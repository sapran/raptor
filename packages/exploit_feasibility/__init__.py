#!/usr/bin/env python3
"""
Exploit Feasibility Module

Provides analysis of mitigations AND exploitation factors to determine
what's actually possible given the target's constraints.

This module should be called BEFORE attempting any exploit development.

Public API (recommended):
    from packages.exploit_feasibility import analyze_binary, check_exploit_viability

    # Full analysis
    result = analyze_binary("/path/to/binary")
    print(result['summary'])

    # Quick viability check
    viable, reason = check_exploit_viability("/path/to/binary", "format_string")

    # Get architectural constraints
    constraints = get_exploit_constraints("x86_64", "strcpy")

Modular Structure:
    - constants.py: Centralized magic numbers and thresholds
    - primitives.py: Exploitation primitives and typed IDs
    - techniques.py: Technique requirements and lookups
    - targets.py: Binary-specific target analysis
    - constraints.py: Input handler, bad byte, and libc fingerprinting analysis
    - graph.py: Primitive dependency graph for path finding
    - cache.py: LRU caching for expensive operations
    - errors.py: Structured error handling
    - context.py: Binary reconnaissance data
    - analyzer.py: Main analysis orchestration
    - api.py: Public API functions
"""

# =============================================================================
# Public API - Clean functions that return dicts/tuples (no class exposure)
# =============================================================================

from .api import (
    analyze_binary,
    check_exploit_viability,
    get_exploit_constraints,
    get_vuln_type_for_rule,
    format_analysis_summary,
    # Context persistence - survives compaction
    save_exploit_context,
    load_exploit_context,
    print_exploit_context,
)

# Typed enums for type-safe code
from .primitives import PrimitiveID, MitigationID, PrimitiveType

# Constants for external use
from .constants import GlibcVersion, Timeout

# Human-readable verdict conversion
from .vuln_types import verdict_to_human

# Constraint analysis functions
from .constraints import (
    analyze_input_constraints,
    analyze_bad_byte_impact,
    assess_libc_fingerprinting,
)

__all__ = [
    # Public API functions
    "analyze_binary",
    "check_exploit_viability",
    "get_exploit_constraints",
    "get_vuln_type_for_rule",
    "format_analysis_summary",
    # Context persistence (survives context compaction)
    "save_exploit_context",
    "load_exploit_context",
    "print_exploit_context",
    # Utilities
    "verdict_to_human",
    # Constraint analysis
    "analyze_input_constraints",
    "analyze_bad_byte_impact",
    "assess_libc_fingerprinting",
    # Typed enums
    "PrimitiveID",
    "MitigationID",
    "PrimitiveType",
    # Constants
    "GlibcVersion",
    "Timeout",
]


# New naming aliases (preferred)
from .analyzer import FeasibilityReport, FeasibilityAnalyzer

# OneGadget for detailed one-gadget analysis
from .context import OneGadget

# Profile creation functions (for remote/web/kernel contexts)
from .profiles import (
    TargetContext,
    TargetProfile,
    create_local_profile,
    create_remote_profile,
    create_web_profile,
    create_kernel_profile,
)

# Add to __all__
__all__ += [
    "FeasibilityReport",
    "FeasibilityAnalyzer",
    "OneGadget",
    "TargetContext",
    "TargetProfile",
    "create_local_profile",
    "create_remote_profile",
    "create_web_profile",
    "create_kernel_profile",
]


# =============================================================================
# Internal API - For use within RAPTOR only (not for user-facing code)
# =============================================================================

def _get_internal_classes():
    """
    Lazy import of internal classes. Use only within RAPTOR codebase.
    These should NOT be exposed to users or mentioned in output.
    """
    from .analyzer import (
        FeasibilityAnalyzer,
        FeasibilityReport,
    )
    from .vuln_types import ExploitabilityVerdict, VulnerabilityType
    from .mitigations import (
        MitigationImpact,
        GlibcMitigation,
        GlibcMitigations,
        KernelMitigation,
        KernelMitigations,
    )
    from .profiles import (
        TargetContext,
        TargetProfile,
        create_local_profile,
        create_remote_profile,
        create_web_profile,
        create_kernel_profile,
    )
    from .strategies import (
        AnalysisStrategy,
        LocalBinaryStrategy,
        RemoteBinaryStrategy,
        WebApplicationStrategy,
        KernelStrategy,
        get_analysis_strategy,
    )
    from .exploit_context import ExploitContext
    from .context import (
        BinaryContext,
        ExploitationConstraints,
        LibcInfo,
        ROPGadgetInfo,
        ELFStructure,
        WriteTarget,
        AddressSpaceInfo,
        SeccompInfo,
        PayloadConstraints,
        ExploitPrimitive,
    )
    return {
        'FeasibilityAnalyzer': FeasibilityAnalyzer,
        'FeasibilityReport': FeasibilityReport,
        'ExploitabilityVerdict': ExploitabilityVerdict,
        'VulnerabilityType': VulnerabilityType,
        'MitigationImpact': MitigationImpact,
        'GlibcMitigation': GlibcMitigation,
        'GlibcMitigations': GlibcMitigations,
        'KernelMitigation': KernelMitigation,
        'KernelMitigations': KernelMitigations,
        'TargetContext': TargetContext,
        'TargetProfile': TargetProfile,
        'create_local_profile': create_local_profile,
        'create_remote_profile': create_remote_profile,
        'create_web_profile': create_web_profile,
        'create_kernel_profile': create_kernel_profile,
        'AnalysisStrategy': AnalysisStrategy,
        'LocalBinaryStrategy': LocalBinaryStrategy,
        'RemoteBinaryStrategy': RemoteBinaryStrategy,
        'WebApplicationStrategy': WebApplicationStrategy,
        'KernelStrategy': KernelStrategy,
        'get_analysis_strategy': get_analysis_strategy,
        'ExploitContext': ExploitContext,
        'BinaryContext': BinaryContext,
        'ExploitationConstraints': ExploitationConstraints,
        'LibcInfo': LibcInfo,
        'ROPGadgetInfo': ROPGadgetInfo,
        'ELFStructure': ELFStructure,
        'WriteTarget': WriteTarget,
        'AddressSpaceInfo': AddressSpaceInfo,
        'SeccompInfo': SeccompInfo,
        'PayloadConstraints': PayloadConstraints,
        'ExploitPrimitive': ExploitPrimitive,
    }
