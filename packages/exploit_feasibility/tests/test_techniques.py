#!/usr/bin/env python3
"""Tests for techniques module."""

import pytest
from ..techniques import (
    TechniqueRequirements,
    get_technique_requirements,
    get_technique,
    get_techniques_for_goal,
    get_viable_techniques,
    get_missing_primitives,
)


class TestTechniqueRequirements:
    """Tests for TechniqueRequirements dataclass."""

    def test_basic_creation(self):
        """Test creating a technique requirements object."""
        req = TechniqueRequirements(
            technique="test_technique",
            description="Test description",
            blocked_by=["full_relro"],
            requires_primitives=["arbitrary_write"],
            provides=["code_execution"],
        )
        assert req.technique == "test_technique"
        assert "full_relro" in req.blocked_by
        assert "arbitrary_write" in req.requires_primitives
        assert "code_execution" in req.provides


class TestGetTechniqueRequirements:
    """Tests for get_technique_requirements function."""

    def test_returns_dict(self):
        """Test that function returns a dictionary."""
        techniques = get_technique_requirements()
        assert isinstance(techniques, dict)

    def test_contains_expected_techniques(self):
        """Test that expected techniques are defined."""
        techniques = get_technique_requirements()
        expected = [
            "format_string_read",
            "format_string_got_overwrite",
            "stack_buffer_overflow_rop",
            "tcache_poison",
            "got_overwrite",
        ]
        for tech_name in expected:
            assert tech_name in techniques, f"Missing technique: {tech_name}"

    def test_techniques_have_descriptions(self):
        """Test that all techniques have descriptions."""
        techniques = get_technique_requirements()
        for name, tech in techniques.items():
            assert tech.description, f"Technique {name} missing description"

    def test_returns_copy(self):
        """Test that function returns a fresh copy each time."""
        t1 = get_technique_requirements()
        t2 = get_technique_requirements()
        t1["test_key"] = "test_value"
        assert "test_key" not in t2


class TestGetTechnique:
    """Tests for get_technique function."""

    def test_existing_technique(self):
        """Test getting an existing technique."""
        req = get_technique("tcache_poison")
        assert req is not None
        assert req.technique == "tcache_poison"

    def test_nonexistent_technique(self):
        """Test getting a non-existent technique."""
        req = get_technique("nonexistent_technique")
        assert req is None


class TestGetTechniquesForGoal:
    """Tests for get_techniques_for_goal function."""

    def test_code_execution_goal(self):
        """Test finding techniques that provide code_execution."""
        techniques = get_techniques_for_goal("code_execution")
        assert len(techniques) > 0
        for tech in techniques:
            assert "code_execution" in tech.provides

    def test_arbitrary_write_goal(self):
        """Test finding techniques that provide arbitrary_write."""
        techniques = get_techniques_for_goal("arbitrary_write")
        assert len(techniques) > 0
        for tech in techniques:
            assert "arbitrary_write" in tech.provides

    def test_nonexistent_goal(self):
        """Test finding techniques for non-existent goal."""
        techniques = get_techniques_for_goal("nonexistent_goal")
        assert len(techniques) == 0


class TestGetViableTechniques:
    """Tests for get_viable_techniques function."""

    def test_no_mitigations(self):
        """Test with no blocking mitigations."""
        viable = get_viable_techniques(
            blocked_mitigations=[],
            available_primitives=["format_string_vuln", "libc_leak"]
        )
        # Should find format_string_got_overwrite with these primitives
        tech_names = [t.technique for t in viable]
        assert "format_string_got_overwrite" in tech_names

    def test_full_relro_blocks_got_overwrite(self):
        """Test that full_relro blocks GOT overwrite."""
        viable = get_viable_techniques(
            blocked_mitigations=["full_relro"],
            available_primitives=["arbitrary_write", "pie_leak"]
        )
        tech_names = [t.technique for t in viable]
        assert "got_overwrite" not in tech_names

    def test_glibc_hooks_removed_blocks_hook_overwrite(self):
        """Test that hooks removed blocks hook overwrite."""
        viable = get_viable_techniques(
            blocked_mitigations=["glibc_hooks_removed"],
            available_primitives=["arbitrary_write", "libc_leak"]
        )
        tech_names = [t.technique for t in viable]
        assert "__malloc_hook_overwrite" not in tech_names
        assert "__free_hook_overwrite" not in tech_names

    def test_missing_primitives_excludes(self):
        """Test that missing primitives exclude techniques."""
        # Without libc_leak, format_string_got_overwrite shouldn't be viable
        viable = get_viable_techniques(
            blocked_mitigations=[],
            available_primitives=["format_string_vuln"]  # No libc_leak
        )
        tech_names = [t.technique for t in viable]
        assert "format_string_got_overwrite" not in tech_names


class TestGetMissingPrimitives:
    """Tests for get_missing_primitives function."""

    def test_all_present(self):
        """Test when all primitives are available."""
        missing = get_missing_primitives(
            "format_string_got_overwrite",
            ["format_string_vuln", "libc_leak"]
        )
        assert len(missing) == 0

    def test_missing_one(self):
        """Test when one primitive is missing."""
        missing = get_missing_primitives(
            "stack_buffer_overflow_ret2libc",
            ["stack_overflow_vuln"]  # Missing libc_leak
        )
        assert "libc_leak" in missing

    def test_missing_all(self):
        """Test when all primitives are missing."""
        missing = get_missing_primitives(
            "stack_buffer_overflow_ret2libc",
            []
        )
        assert "stack_overflow_vuln" in missing
        assert "libc_leak" in missing

    def test_nonexistent_technique(self):
        """Test with non-existent technique."""
        missing = get_missing_primitives(
            "nonexistent_technique",
            ["some_primitive"]
        )
        assert len(missing) == 0
