#!/usr/bin/env python3
"""Tests for context module."""

import pytest
from ..context import (
    ExploitationConstraints,
    PayloadConstraints,
    LibcInfo,
    ROPGadgetInfo,
    ELFStructure,
    AddressSpaceInfo,
)


class TestExploitationConstraints:
    """Tests for ExploitationConstraints dataclass."""

    def test_x86_64_defaults(self):
        """Test x86_64 architecture defaults."""
        constraints = ExploitationConstraints(arch="x86_64")
        assert constraints.pointer_size == 8
        assert constraints.null_byte_position == 6
        assert constraints.max_strcpy_bytes == 6

    def test_x86_64_strcpy_blocks_rop(self):
        """Test that x86_64 with strcpy blocks ROP."""
        constraints = ExploitationConstraints(arch="x86_64", input_handler="strcpy")
        assert constraints.strcpy_rop_viable is False
        assert len(constraints.blocked_techniques) > 0
        assert any("ROP" in t for t in constraints.blocked_techniques)

    def test_i386_defaults(self):
        """Test i386 architecture defaults."""
        constraints = ExploitationConstraints(arch="i386")
        assert constraints.pointer_size == 4
        assert constraints.null_byte_position == 4

    def test_i386_strcpy_allows_rop(self):
        """Test that i386 with strcpy may allow ROP."""
        constraints = ExploitationConstraints(arch="i386", input_handler="strcpy")
        assert constraints.strcpy_rop_viable is True

    def test_aarch64_defaults(self):
        """Test AArch64 architecture defaults."""
        constraints = ExploitationConstraints(arch="aarch64")
        assert constraints.pointer_size == 8
        assert constraints.null_byte_position == 6

    def test_aarch64_strcpy_blocks_rop(self):
        """Test that AArch64 with strcpy blocks ROP."""
        constraints = ExploitationConstraints(arch="aarch64", input_handler="strcpy")
        assert constraints.strcpy_rop_viable is False

    def test_arm32_defaults(self):
        """Test ARM32 architecture defaults."""
        constraints = ExploitationConstraints(arch="arm")
        assert constraints.pointer_size == 4
        assert constraints.null_byte_position == 4

    def test_arm32_strcpy_allows_rop(self):
        """Test that ARM32 with strcpy may allow ROP."""
        constraints = ExploitationConstraints(arch="arm", input_handler="strcpy")
        assert constraints.strcpy_rop_viable is True
        assert "Thumb" in constraints.strcpy_rop_reason

    def test_mips32_defaults(self):
        """Test MIPS32 architecture defaults."""
        constraints = ExploitationConstraints(arch="mips")
        assert constraints.pointer_size == 4
        assert "delay slot" in constraints.strcpy_rop_reason

    def test_mips64_defaults(self):
        """Test MIPS64 architecture defaults."""
        constraints = ExploitationConstraints(arch="mips64")
        assert constraints.pointer_size == 8
        assert constraints.strcpy_rop_viable is False

    def test_summary_format(self):
        """Test summary output format."""
        constraints = ExploitationConstraints(arch="x86_64", input_handler="strcpy")
        summary = constraints.summary()
        assert "EXPLOITATION CONSTRAINTS" in summary
        assert "x86_64" in summary
        assert "8-byte pointers" in summary


class TestPayloadConstraints:
    """Tests for PayloadConstraints dataclass."""

    def test_default_empty(self):
        """Test default empty constraints."""
        constraints = PayloadConstraints()
        assert len(constraints.bad_bytes) == 0
        assert constraints.input_handler == ""

    def test_with_bad_bytes(self):
        """Test with bad bytes set."""
        constraints = PayloadConstraints(bad_bytes=[0x00, 0x0a, 0x0d])
        assert 0x00 in constraints.bad_bytes
        assert 0x0a in constraints.bad_bytes

    def test_summary_format(self):
        """Test summary output format."""
        constraints = PayloadConstraints(
            bad_bytes=[0x00, 0x0a],
            input_handler="strcpy"
        )
        summary = constraints.summary()
        assert "PAYLOAD CONSTRAINTS" in summary
        assert "strcpy" in summary
        assert "0x00" in summary


class TestLibcInfo:
    """Tests for LibcInfo dataclass."""

    def test_default_empty(self):
        """Test default empty info."""
        info = LibcInfo()
        assert info.path == ""
        assert info.system_offset is None

    def test_summary_format(self):
        """Test summary output format."""
        info = LibcInfo(
            path="/lib/x86_64-linux-gnu/libc.so.6",
            system_offset=0x50d60,
            one_gadgets=[0x4f3d5, 0x4f432]
        )
        summary = info.summary()
        assert "LIBC INFO" in summary
        assert "system()" in summary
        assert "One-gadgets" in summary


class TestROPGadgetInfo:
    """Tests for ROPGadgetInfo dataclass."""

    def test_default_empty(self):
        """Test default empty info."""
        info = ROPGadgetInfo()
        assert info.total_gadgets == 0
        assert info.pop_rdi_ret is None

    def test_summary_format(self):
        """Test summary output format."""
        info = ROPGadgetInfo(
            total_gadgets=1000,
            usable_gadgets=950,
            pop_rdi_ret=0x4011a3,
            ret=0x401016
        )
        summary = info.summary()
        assert "ROP GADGETS" in summary
        assert "1000" in summary
        assert "pop rdi" in summary


class TestELFStructure:
    """Tests for ELFStructure dataclass."""

    def test_default_empty(self):
        """Test default empty structure."""
        structure = ELFStructure()
        assert structure.got_plt_addr is None
        assert len(structure.got_entries) == 0

    def test_summary_format(self):
        """Test summary output format."""
        structure = ELFStructure(
            got_plt_addr=0x404000,
            got_plt_size=0x100,
            got_entries={"puts": 0x404018, "printf": 0x404020}
        )
        summary = structure.summary()
        assert "ELF STRUCTURE" in summary
        assert ".got.plt" in summary
        assert "2" in summary  # 2 GOT entries


class TestAddressSpaceInfo:
    """Tests for AddressSpaceInfo dataclass."""

    def test_default_empty(self):
        """Test default empty info."""
        info = AddressSpaceInfo()
        assert info.binary_base_sample is None
        assert info.null_byte_position == 6

    def test_summary_format(self):
        """Test summary output format."""
        info = AddressSpaceInfo(
            binary_base_sample=0x555555554000,
            binary_entropy_bits=28,
            binary_has_nulls=True
        )
        summary = info.summary()
        assert "ADDRESS SPACE" in summary
        assert "Binary" in summary
