#!/usr/bin/env python3
"""Tests for extended dataclass fields (ROP gadgets, ELF structure, constraints)."""

import pytest
from ..context import (
    ROPGadgetInfo,
    ELFStructure,
    AddressSpaceInfo,
    PayloadConstraints,
    ExploitPrimitive,
    WriteTarget,
)


class TestROPGadgetInfoExtended:
    """Tests for extended ROP gadget fields (ret2csu, stack pivot, charset)."""

    def test_extended_gadgets_default_to_none(self):
        """Test that extended gadget fields default to None."""
        info = ROPGadgetInfo()
        assert info.pop_rbx_ret is None
        assert info.pop_rcx_ret is None
        assert info.pop_rbp_ret is None
        assert info.pop_rsp_ret is None
        assert info.leave_ret is None
        assert info.call_rax is None

    def test_extended_gadgets_set(self):
        """Test setting extended gadget addresses."""
        info = ROPGadgetInfo(
            pop_rbx_ret=0x401100,
            pop_rcx_ret=0x401110,
            pop_rbp_ret=0x401120,
            pop_rsp_ret=0x401130,
            leave_ret=0x401140,
            call_rax=0x401150,
        )
        assert info.pop_rbx_ret == 0x401100
        assert info.pop_rcx_ret == 0x401110
        assert info.pop_rbp_ret == 0x401120
        assert info.pop_rsp_ret == 0x401130
        assert info.leave_ret == 0x401140
        assert info.call_rax == 0x401150

    def test_charset_filtering_fields(self):
        """Test charset filtering count fields."""
        info = ROPGadgetInfo(
            filtered_by_charset=15,
            printable_gadgets=20,
            alphanumeric_gadgets=5,
        )
        assert info.filtered_by_charset == 15
        assert info.printable_gadgets == 20
        assert info.alphanumeric_gadgets == 5

    def test_all_gadgets_list(self):
        """Test all_gadgets list storage."""
        gadgets = [
            {'address': 0x401100, 'instruction': 'pop rdi ; ret'},
            {'address': 0x401110, 'instruction': 'pop rsi ; ret'},
        ]
        info = ROPGadgetInfo(all_gadgets=gadgets)
        assert len(info.all_gadgets) == 2
        assert info.all_gadgets[0]['address'] == 0x401100

    def test_summary_includes_extended_gadgets(self):
        """Test that summary includes extended gadgets when set."""
        info = ROPGadgetInfo(
            total_gadgets=100,
            usable_gadgets=50,
            pop_rdi_ret=0x401100,
            pop_rbx_ret=0x401110,
            leave_ret=0x401120,
        )
        summary = info.summary()
        assert "ROP GADGETS" in summary
        # Extended gadgets should appear in summary if set


class TestELFStructureExtended:
    """Tests for ELF structure fields (init_array, PLT stub size)."""

    def test_init_array_fields(self):
        """Test .init_array fields."""
        struct = ELFStructure(
            init_array_addr=0x3da8,
            init_array_size=8,
        )
        assert struct.init_array_addr == 0x3da8
        assert struct.init_array_size == 8

    def test_plt_stub_size_default(self):
        """Test plt_stub_size default value."""
        struct = ELFStructure()
        assert struct.plt_stub_size == 16  # Default for x86_64

    def test_plt_stub_size_custom(self):
        """Test setting custom plt_stub_size."""
        struct = ELFStructure(plt_stub_size=32)
        assert struct.plt_stub_size == 32

    def test_summary_includes_init_array(self):
        """Test that summary mentions init_array when set."""
        struct = ELFStructure(
            got_plt_addr=0x404000,
            init_array_addr=0x3da8,
            init_array_size=8,
        )
        summary = struct.summary()
        assert "ELF STRUCTURE" in summary


class TestAddressSpaceInfoExtended:
    """Tests for address space fields (linker base sampling)."""

    def test_ld_base_sample_default(self):
        """Test ld_base_sample defaults to None."""
        info = AddressSpaceInfo()
        assert info.ld_base_sample is None

    def test_ld_base_sample_set(self):
        """Test setting ld_base_sample."""
        info = AddressSpaceInfo(ld_base_sample=0x7f1234567000)
        assert info.ld_base_sample == 0x7f1234567000

    def test_summary_includes_ld_base(self):
        """Test that summary includes linker base when set."""
        info = AddressSpaceInfo(
            binary_base_sample=0x555555554000,
            ld_base_sample=0x7f1234567000,
        )
        summary = info.summary()
        assert "ADDRESS SPACE" in summary


class TestPayloadConstraintsExtended:
    """Tests for payload constraint fields (bad byte reasons, charset)."""

    def test_bad_byte_reasons_default(self):
        """Test bad_byte_reasons defaults to empty dict."""
        constraints = PayloadConstraints()
        assert constraints.bad_byte_reasons == {}

    def test_bad_byte_reasons_set(self):
        """Test setting bad_byte_reasons."""
        constraints = PayloadConstraints(
            bad_bytes=[0x00, 0x0a],
            bad_byte_reasons={0x00: 'null terminator', 0x0a: 'newline'}
        )
        assert constraints.bad_byte_reasons[0x00] == 'null terminator'
        assert constraints.bad_byte_reasons[0x0a] == 'newline'

    def test_max_embeddable_addresses_default(self):
        """Test max_embeddable_addresses defaults to 0."""
        constraints = PayloadConstraints()
        assert constraints.max_embeddable_addresses == 0

    def test_allowed_charset_default(self):
        """Test allowed_charset defaults to empty string."""
        constraints = PayloadConstraints()
        assert constraints.allowed_charset == ""

    def test_allowed_charset_set(self):
        """Test setting allowed_charset."""
        constraints = PayloadConstraints(allowed_charset="printable")
        assert constraints.allowed_charset == "printable"

    def test_encoding_suggestions_default(self):
        """Test encoding_suggestions defaults to empty list."""
        constraints = PayloadConstraints()
        assert constraints.encoding_suggestions == []

    def test_encoding_suggestions_set(self):
        """Test setting encoding_suggestions."""
        constraints = PayloadConstraints(
            encoding_suggestions=['Use base64 encoding', 'Consider URL encoding']
        )
        assert len(constraints.encoding_suggestions) == 2

    def test_must_be_printable_flag(self):
        """Test must_be_printable flag."""
        constraints = PayloadConstraints(must_be_printable=True)
        assert constraints.must_be_printable is True


class TestExploitPrimitiveFields:
    """Tests for ExploitPrimitive dataclass."""

    def test_required_name_field(self):
        """Test that name is required."""
        prim = ExploitPrimitive(name="test_vuln")
        assert prim.name == "test_vuln"
        assert prim.arbitrary_read is False
        assert prim.arbitrary_write is False
        assert prim.limited_write is False

    def test_write_fields(self):
        """Test write-related fields."""
        prim = ExploitPrimitive(
            name="format_string",
            arbitrary_write=True,
            write_size="1-8 bytes",
            write_count="multiple",
            limited_write=False,
        )
        assert prim.arbitrary_write is True
        assert prim.write_size == "1-8 bytes"
        assert prim.write_count == "multiple"
        assert prim.limited_write is False

    def test_limited_write_flag(self):
        """Test limited_write flag for constrained writes."""
        prim = ExploitPrimitive(
            name="buffer_overflow",
            arbitrary_write=False,
            limited_write=True,
            write_size="sequential",
            write_count="once",
        )
        assert prim.limited_write is True
        assert prim.arbitrary_write is False


class TestWriteTargetFields:
    """Tests for WriteTarget dataclass."""

    def test_default_values(self):
        """Test default values."""
        target = WriteTarget(name="test", address=0x404000)
        assert target.is_absolute is False  # Default is False (offset)
        assert target.writable is True
        assert target.needs_leak is True
        assert target.reliability == "medium"

    def test_absolute_address(self):
        """Test absolute address flag."""
        target = WriteTarget(
            name=".got.plt",
            address=0x404000,
            is_absolute=True,
        )
        assert target.is_absolute is True

    def test_writable_flag(self):
        """Test writable flag for blocked targets."""
        target = WriteTarget(
            name=".got.plt",
            address=0x404000,
            writable=False,
            notes="Full RELRO",
        )
        assert target.writable is False
        assert target.notes == "Full RELRO"

    def test_summary_shows_offset_for_relative(self):
        """Test that summary shows offset for relative addresses."""
        target = WriteTarget(
            name=".fini_array",
            address=0x3da8,
            is_absolute=False,
        )
        summary = target.summary()
        # Should indicate it's a relative address (offset)
        assert ".fini_array" in summary
        assert "offset" in summary.lower()


class TestRet2CSUViability:
    """Tests for ret2csu detection logic."""

    def test_ret2csu_requires_pop_rbx_and_pop_rbp(self):
        """Test that ret2csu needs both pop_rbx and pop_rbp."""
        # Has both - viable
        info_viable = ROPGadgetInfo(
            pop_rbx_ret=0x401100,
            pop_rbp_ret=0x401110,
        )
        assert info_viable.pop_rbx_ret is not None
        assert info_viable.pop_rbp_ret is not None

        # Missing pop_rbx - not viable
        info_missing = ROPGadgetInfo(
            pop_rbp_ret=0x401110,
        )
        assert info_missing.pop_rbx_ret is None


class TestStackPivotViability:
    """Tests for stack pivot detection logic."""

    def test_stack_pivot_with_leave_ret(self):
        """Test stack pivot detection with leave_ret gadget."""
        info = ROPGadgetInfo(leave_ret=0x401100)
        assert info.leave_ret is not None

    def test_stack_pivot_with_pop_rsp(self):
        """Test stack pivot detection with pop_rsp gadget."""
        info = ROPGadgetInfo(pop_rsp_ret=0x401100)
        assert info.pop_rsp_ret is not None

    def test_no_stack_pivot_gadgets(self):
        """Test when no stack pivot gadgets available."""
        info = ROPGadgetInfo()
        assert info.leave_ret is None
        assert info.pop_rsp_ret is None
